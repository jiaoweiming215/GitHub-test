
---
# Protothreads简介
---

Protothreads简介是一种针对C语言封装后的宏函数库，为C语言模拟了一种无堆栈的轻量线程环境，能够实现模拟线程的条件阻塞、信号量操作等操作系统中特有的机制，从而使程序实现多线程操作。
每个Protothreads线程仅增加10行代码和2字节RAM的额外硬件资源消耗。对于资源紧缺而不能移植嵌入式操作系统的嵌入式系统，使用Protothreads能够方便直观设计多任务程序，能够实现用线性程序结构处理事件驱动型程序和状态机程序，简化了该程序的设计。

---
特性：
1.没有专门的机器代码，纯C实现；
2.不用容易犯错的跳转指令；
3.极小的内存占用；
4.当不当操作系统都行；
5.所提供的阻断等待不需要堆栈或full multi-threading

---
代码实现保存任务状态的功能，实际上LC_RESUME,LC_SET,LC_END组成一个switch结构，把整个任务包在其中，每次退出时LC_SET将当前的行号保存在全局变量s中，
当下次运行时switch语句根据s的值直接跳到LC_SET的下一条语句。所以我们每个任务只需要额外的一个整型变量保存行号就可以了。

pt.h中封装了struct pt结构体，这是protothreads的任务控制块，结构体成员lc用于包存行号。

---
宏介绍：
PT_INIT宏是线程初始化宏，在线程开始运行之前，需要调用宏进行初始化，将行号初始化为0，使线程从0开始执行。

PT_BEGIN宏是LC_RESUME的封装，表示线程开始，必须放在线程中的最开始处，是构成switch的起始部分。

PT_WAIT_UNTIL宏是阻塞这个线程知道某个条件成立，先调用LC_SET宏设置一个断点，然后判断条件是否成立，如不成立直接返回，当线程第二次进入时会直接跳到
    这个if语句上继续判断条件是否成立。

PT_END宏先调用LC_END宏结束整个switch,然后调用LC_INIT宏重新初始化线程控制块，在下次可以从头开始。
